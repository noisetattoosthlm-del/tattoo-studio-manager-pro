<script>
    const supabaseUrl = 'https://yunuwkjydqzgkqtbgwup.supabase.co'; 
    const supabaseKey = 'sb_publishable_J66CdYuykkwjyulPJp2O1Q_e0ZZLXe7'; 
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    let userProfile = null, editingId = null, globalApps = [], myChart = null, selectedCurrency = 'EUR';

    function setCurrency(curr) {
        selectedCurrency = curr;
        document.getElementById('sel-eur').className = curr === 'EUR' ? 'active' : '';
        document.getElementById('sel-rsd').className = curr === 'RSD' ? 'active' : '';
    }

    async function initDashboard() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) { window.location.href = 'index.html'; return; }
        const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single();
        if (profile) {
            userProfile = profile;
            if (profile.role === 'owner') {
                document.querySelectorAll('.owner-only').forEach(el => el.style.display = 'flex');
                popuniArtistFilter();
            }
        }
        popuniMeseceIGodine();
        osveziPodatke();
    }

    function popuniMeseceIGodine() {
        const mFilter = document.getElementById('month-select'), yFilter = document.getElementById('year-select');
        const meseci = ["Januar", "Februar", "Mart", "April", "Maj", "Jun", "Jul", "Avgust", "Septembar", "Oktobar", "Novembar", "Decembar"];
        const d = new Date();
        if(!mFilter) return;
        meseci.forEach((ime, i) => {
            let opt = document.createElement('option'); opt.value = String(i + 1).padStart(2, '0'); opt.innerHTML = ime;
            if(i === d.getMonth()) opt.selected = true; mFilter.appendChild(opt);
        });
        for(let y = 2024; y <= 2030; y++) {
            let opt = document.createElement('option'); opt.value = y; opt.innerHTML = y;
            if(y === d.getFullYear()) opt.selected = true; yFilter.appendChild(opt);
        }
    }

    async function popuniArtistFilter() {
        const { data } = await supabaseClient.from('profiles').select('id, full_name').eq('studio_id', userProfile.studio_id);
        const filter = document.getElementById('artist-filter');
        if(!filter) return;
        data?.forEach(a => { let opt = document.createElement('option'); opt.value = a.id; opt.innerHTML = a.full_name; filter.appendChild(opt); });
    }

    async function osveziPodatke() {
        try {
            const m = document.getElementById('month-select').value;
            const y = document.getElementById('year-select').value;
            const artF = document.getElementById('artist-filter')?.value || 'all';
            const selM = `${y}-${m}`;
            
            let q = supabaseClient.from('appointments').select('*').eq('studio_id', userProfile.studio_id);
            if (userProfile.role !== 'owner') q = q.eq('artist_id', userProfile.id);
            else if (artF !== 'all') q = q.eq('artist_id', artF);
            
            const { data: apps } = await q.order('appointment_time', {ascending: true});
            const { data: troskovi } = await supabaseClient.from('expenses').select('*').eq('studio_id', userProfile.studio_id);

            if (apps) {
                globalApps = apps;
                let filtered = apps.filter(a => a.appointment_time?.startsWith(selM));
                let fTroskovi = troskovi?.filter(t => t.created_at.startsWith(selM)) || [];

                const calc = (cur) => {
                    const ugovoreno = filtered.filter(a => a.status !== 'no-show' && (a.currency || 'EUR') === cur).reduce((s, a) => s + (Number(a.total_price) || 0), 0);
                    const depozit = filtered.filter(a => a.status === 'zakazano' && (a.currency || 'EUR') === cur).reduce((s, a) => s + (Number(a.deposit) || 0), 0);
                    const tSum = (userProfile.role === 'owner' && artF === 'all') ? fTroskovi.filter(t => (t.currency || 'EUR') === cur).reduce((s, t) => s + Number(t.amount), 0) : 0;
                    const pTermini = filtered.filter(a => (a.currency || 'EUR') === cur).reduce((s, a) => {
                        let udeo = 0;
                        if (a.status === 'zavr≈°eno') udeo = (userProfile.role === 'owner') ? a.studio_share : (a.total_price - a.studio_share);
                        else if (a.status === 'no-show' && a.deposit > 0) udeo = (userProfile.role === 'owner') ? a.deposit : 0;
                        return s + udeo;
                    }, 0);
                    return { ugovoreno, depozit, profit: pTermini - tSum };
                };

                const e = calc('EUR'), r = calc('RSD');
                document.getElementById('total-sum-eur').innerText = `‚Ç¨${e.ugovoreno}`;
                document.getElementById('total-sum-rsd').innerText = `${r.ugovoreno} RSD`;
                document.getElementById('studio-sum-eur').innerText = `‚Ç¨${e.profit.toFixed(0)}`;
                document.getElementById('studio-sum-rsd').innerText = `${r.profit.toFixed(0)} RSD`;
                document.getElementById('deposit-sum-eur').innerText = `‚Ç¨${e.depozit}`;
                document.getElementById('deposit-sum-rsd').innerText = `${r.depozit} RSD`;

                inicijalizujGrafikon(filtered, y, m);
                renderujTabelu(filtered);
            }
        } catch (err) { console.error("Gre≈°ka pri osve≈æavanju:", err); }
    }

    function renderujTabelu(filteredApps) {
        let h = `<table><tr><th>Klijent</th><th style="text-align: center;">Status</th><th>Datum</th><th>Cena</th><th style="text-align:right;">Akcije</th></tr>`;
        filteredApps.forEach(a => {
            const datum = new Date(a.appointment_time).toLocaleString('sr-RS', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'});
            const isPayed = a.payout_status === 'isplaƒáeno';
            const pIcon = a.payment_type === 'Card' ? 'üí≥' : 'üíµ';
            const curSymbol = (a.currency === 'RSD') ? ' RSD' : '‚Ç¨';
            let statusBadge = (a.status === 'zavr≈°eno') ? '<div class="check-badge">‚úì</div>' : (a.status === 'no-show') ? '<span class="status-noshow">NO-SHOW</span>' : '<span class="status-zakazano">ZAKAZANO</span>';

            h += `<tr>
                <td><div style="font-weight:800;">${a.client_name}</div><div style="font-size:0.65rem; color:#64748b;">${a.client_instagram || '-'}</div></td>
                <td style="text-align:center;">${statusBadge}${isPayed ? '<div class="pay-badge" title="Isplaƒáeno">üí∏</div>' : ''}</td>
                <td>${datum}h</td>
                <td>${(a.currency === 'RSD' ? '' : '‚Ç¨')}${a.total_price}${curSymbol} <span>${pIcon}</span></td>
                <td style="text-align:right;"><div class="action-cell">
                    ${a.status === 'zakazano' ? `<button class="btn-action-done" onclick="updateStatus('${a.id}', 'zavr≈°eno')">Zavr≈°i</button><button class="btn-action-noshow" onclick="updateStatus('${a.id}', 'no-show')">No-Show</button>` : ''}
                    <button class="btn-action-edit" onclick="otvoriModalEdit('${a.id}')">‚úèÔ∏è</button>
                    <button class="btn-action-delete" onclick="obrisiTermin('${a.id}')">Obri≈°i</button>
                </div></td></tr>`;
        });
        document.getElementById('tabela-div').innerHTML = h + `</table>`;
    }

    async function saveData() {
        const saveBtn = document.getElementById('save-btn');
        saveBtn.disabled = true; 
        saveBtn.innerText = "ƒåUVANJE...";
        
        try {
            const cena = parseFloat(document.getElementById('total_price').value) || 0;
            const procenat = parseFloat(document.getElementById('artist_percent').value) || 50;
            const depozit = parseFloat(document.getElementById('deposit_amt').value) || 0;
            
            const payload = {
                client_name: document.getElementById('c_name').value || "Nepoznato", 
                client_phone: document.getElementById('c_phone').value || "",
                client_instagram: document.getElementById('c_insta').value || "",
                appointment_time: document.getElementById('app_time').value, 
                total_price: cena, 
                deposit: depozit,
                artist_percentage: procenat, 
                studio_share: cena * ((100 - procenat) / 100),
                payment_type: document.getElementById('payment_type').value,
                currency: selectedCurrency
            };

            if (!payload.appointment_time) {
                alert("Morate izabrati datum i vreme!");
                saveBtn.disabled = false;
                saveBtn.innerText = "SAƒåUVAJ";
                return;
            }

            if (editingId) {
                const { error } = await supabaseClient.from('appointments').update(payload).eq('id', editingId);
                if (error) throw error;
            } else {
                const { data: { user } } = await supabaseClient.auth.getUser();
                const { error } = await supabaseClient.from('appointments').insert([{ 
                    ...payload, 
                    artist_id: user.id, 
                    studio_id: userProfile.studio_id, 
                    status: 'zakazano', 
                    payout_status: 'nema' 
                }]);
                if (error) throw error;
            }
            zatvoriModal(); 
            await osveziPodatke();
        } catch (err) { 
            console.error("Save Error:", err);
            alert("Gre≈°ka pri ƒçuvanju: " + err.message); 
        } finally { 
            saveBtn.disabled = false; 
            saveBtn.innerText = "SAƒåUVAJ"; 
        }
    }

    async function dodajTrosak() {
        const title = document.getElementById('exp-title').value;
        const amount = parseFloat(document.getElementById('exp-amount').value);
        const currency = document.getElementById('exp-currency').value;
        
        if(!title || isNaN(amount)) {
            alert("Unesite opis i ispravan iznos tro≈°ka.");
            return;
        }

        try {
            const { error } = await supabaseClient.from('expenses').insert([{ 
                studio_id: userProfile.studio_id, 
                title: title, 
                amount: amount, 
                currency: currency 
            }]);
            
            if (error) throw error;

            document.getElementById('exp-title').value = ''; 
            document.getElementById('exp-amount').value = '';
            await ucitajTroskovi(); 
            await osveziPodatke();
        } catch (err) {
            console.error("Expense Error:", err);
            alert("Gre≈°ka pri dodavanju tro≈°ka: " + err.message);
        }
    }

    async function ucitajTroskovi() {
        try {
            const { data } = await supabaseClient.from('expenses').select('*').eq('studio_id', userProfile.studio_id).order('created_at', {ascending: false});
            let html = '';
            data?.forEach(t => { 
                const s = t.currency === 'RSD' ? ' RSD' : '‚Ç¨';
                html += `<tr><td><strong>${t.title}</strong></td><td style="color:#ef4444;">-${t.amount}${s}</td><td>${new Date(t.created_at).toLocaleDateString()}</td><td style="text-align:right;"><button class="btn-action-delete" onclick="obrisiTrosak('${t.id}')">X</button></td></tr>`;
            });
            document.getElementById('expenses-list-body').innerHTML = html;
        } catch (e) { console.error(e); }
    }

    async function ucitajKlijenti() {
        const { data } = await supabaseClient.from('appointments').select('*').eq('studio_id', userProfile.studio_id).order('appointment_time', {ascending: false});
        let html = '';
        if (data) {
            const map = {};
            data.forEach(a => { if(!map[a.client_name]) map[a.client_name] = a; });
            Object.values(map).forEach(c => {
                html += `<tr><td><strong>${c.client_name}</strong></td><td>${c.client_phone || '-'}</td><td>${c.client_instagram || '-'}</td><td>${new Date(c.appointment_time).toLocaleDateString()}</td><td style="text-align:right;"><button class="btn-action-done" onclick="otvoriModalNoviSaKlijentom('${c.client_name.replace(/'/g, "\\'")}','${c.client_phone}','${c.client_instagram}')">+ NOVI</button></td></tr>`;
            });
        }
        document.getElementById('clients-list-body').innerHTML = html;
    }

    async function ucitajArtiste() {
        const { data: artisti } = await supabaseClient.from('profiles').select('*').eq('studio_id', userProfile.studio_id);
        const { data: termini } = await supabaseClient.from('appointments').select('*').eq('studio_id', userProfile.studio_id).eq('status', 'zavr≈°eno');
        let html = '';
        artisti?.forEach(a => {
            const promet = termini?.filter(t => t.artist_id === a.id).reduce((s,t) => s + Number(t.total_price), 0) || 0;
            html += `<tr><td><strong>${a.full_name}</strong></td><td>${a.role}</td><td>${termini?.filter(t => t.artist_id === a.id).length}</td><td>‚Ç¨${promet}</td><td style="text-align:right;"><button class="btn-action-delete" onclick="obrisiProfil('${a.id}')">Ukloni</button></td></tr>`;
        });
        document.getElementById('artists-list-body').innerHTML = html;
    }

    function otvoriModalNovi() {
        editingId = null;
        document.getElementById('modal-title').innerText = "Novi Termin";
        document.querySelectorAll('#bookingModal input').forEach(i => i.value = "");
        document.getElementById('deposit_amt').value = "0";
        document.getElementById('artist_percent').value = "50";
        setCurrency('EUR');
        document.getElementById('bookingModal').style.display = 'block';
    }

    function otvoriModalEdit(id) {
        const a = globalApps.find(x => x.id === id);
        if(!a) return;
        editingId = id;
        document.getElementById('modal-title').innerText = "Izmeni Termin";
        document.getElementById('c_name').value = a.client_name;
        document.getElementById('c_phone').value = a.client_phone || "";
        document.getElementById('c_insta').value = a.client_instagram || "";
        document.getElementById('app_time').value = a.appointment_time.substring(0, 16);
        document.getElementById('total_price').value = a.total_price;
        document.getElementById('deposit_amt').value = a.deposit;
        document.getElementById('artist_percent').value = a.artist_percentage;
        setCurrency(a.currency || 'EUR');
        document.getElementById('bookingModal').style.display = 'block';
    }

    function prikaziSekciju(s) {
        document.getElementById('dashboard-section').style.display = s === 'dashboard' ? 'block' : 'none';
        document.getElementById('klijenti-section').style.display = s === 'klijenti' ? 'block' : 'none';
        document.getElementById('artisti-section').style.display = s === 'artisti' ? 'block' : 'none';
        document.getElementById('troskovi-section').style.display = s === 'troskovi' ? 'block' : 'none';
        
        const navs = ['nav-dash', 'nav-klijenti', 'nav-artisti', 'nav-troskovi'];
        navs.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.classList.remove('active');
        });
        const activeNav = document.getElementById('nav-' + (s === 'dashboard' ? 'dash' : s));
        if(activeNav) activeNav.classList.add('active');

        if(s === 'klijenti') ucitajKlijenti();
        if(s === 'artisti') ucitajArtiste();
        if(s === 'troskovi') ucitajTroskovi();
    }

    function inicijalizujGrafikon(apps, y, m) {
        const days = new Date(y, m, 0).getDate();
        const data = Array(days).fill(0);
        apps.filter(a => a.status === 'zavr≈°eno' && (a.currency || 'EUR') === 'EUR').forEach(a => {
            data[new Date(a.appointment_time).getDate()-1] += (userProfile.role === 'owner' ? a.studio_share : a.total_price - a.studio_share);
        });
        const ctx = document.getElementById('revenueChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, { type: 'line', data: { labels: Array.from({length: days}, (_, i) => i+1), datasets: [{ label: 'Profit (‚Ç¨)', data: data, borderColor: '#3b82f6', tension: 0.4, fill: true, backgroundColor: 'rgba(59,130,246,0.1)' }] }, options: { responsive: true, maintainAspectRatio: false } });
    }

    async function updateStatus(id, s) { await supabaseClient.from('appointments').update({ status: s }).eq('id', id); osveziPodatke(); }
    async function obrisiTermin(id) { if(confirm("Obri≈°i?")) { await supabaseClient.from('appointments').delete().eq('id', id); osveziPodatke(); } }
    async function obrisiTrosak(id) { if(confirm("Obri≈°i tro≈°ak?")) { await supabaseClient.from('expenses').delete().eq('id', id); ucitajTroskovi(); osveziPodatke(); } }
    function zatvoriModal() { document.getElementById('bookingModal').style.display = 'none'; }
    async function logout() { await supabaseClient.auth.signOut(); window.location.href = 'index.html'; }

    initDashboard();
</script>
